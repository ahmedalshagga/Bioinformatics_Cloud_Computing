---
title: "Reproduction of Critical Roles of the Pentose Phosphate Pathway and GLN3 in Isobutanol-Specific Tolerance in Yeast RNA-Seq Analysis"
format: html
editor: visual
---n
---

## Introduction

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
install.packages("ggrepel")
install.packages("BiocManager")
BiocManager::install("EnhancedVolcano")
BiocManager::install("clusterProfiler")
BiocManager::install("org.Sc.sgd.db")
BiocManager::install("enrichplot")
library(clusterProfiler)
library(org.Sc.sgd.db)
library(dplyr)
library(ggplot2)
library(readr)
library(ggrepel)
library(EnhancedVolcano)
library(readxl)
```

This notebook documents the analysis and visualization of RNA-seq data from the reproduction of Kuroda et al (2019). The pipeline consisted of alignment (TopHat), quantification (Cufflinks), and differentrial expression analysis (Cuffdiff) within the HPC cluster environment.
To validate the results from our pipeline, we compare our log2 fold change 
values against the authors' published values (supplied in Supplementary 
materials, "Summary_of_RNA_seq_analysis_of_duplicates.txt) via volcano plot 
visualization.

Here we load results, validate them against the published data supplied in Supplementary Info and visualize the key findings.

### Loading Data

```{r}
group_results_path <- "../processed_data/cuffdiff/gene_exp.diff"

# 1. Load results
our_data <- read.delim(group_results_path, header = TRUE, stringsAsFactors = FALSE)

group_results <- our_data %>%
  filter(sample_1 == "gln3_Iso", sample_2 == "WT_Iso") %>% 
  select(gene_id, locus, log2FC = log2.fold_change., pval = p_value, qval = q_value)

paper_results_path <- "../processed_data/Papers_Results"

# Read the paper table
paper_raw <- read.delim(
  paper_results_path,
  header = FALSE,
  stringsAsFactors = FALSE,
  check.names = FALSE
)

# Clean paper data
paper_dat <- paper_raw %>%
  dplyr::slice(4:n()) %>%
  dplyr::select(-c(17, 21, 25, 29, 33))

# Assign columns
colnames(paper_dat) <- c(
  "SystematicName", "GeneName", "NameDescription", "Locus",
  "WT0_Rep1", "WT0_Rep2", "WT0_mean",
  "WTIso_Rep1", "WTIso_Rep2", "WTIso_mean",
  "Gln30_Rep1", "Gln30_Rep2", "Gln30_mean",
  "Gln3Iso_Rep1", "Gln3Iso_Rep2", "Gln3Iso_mean",
  "Gln3Iso_vs_WTIso_log2FC", "Gln3Iso_vs_WTIso_p", "Gln3Iso_vs_WTIso_q",
  "Gln30_vs_WT0_log2FC",     "Gln30_vs_WT0_p",     "Gln30_vs_WT0_q",
  "Gln3Iso_vs_Gln30_log2FC", "Gln3Iso_vs_Gln30_p", "Gln3Iso_vs_Gln30_q",
  "WTIso_vs_WT0_log2FC",     "WTIso_vs_WT0_p",     "WTIso_vs_WT0_q",
  "Gln3Iso_vs_WT0_log2FC",   "Gln3Iso_vs_WT0_p",   "Gln3Iso_vs_WT0_q"
) #Inspected files for this

print(paste("Loaded", nrow(group_results), "genes from our analysis."))

print(paste("Loaded", nrow(paper_dat), "genes from papers analysis."))

```

We were able to load the same region of genes \~6,000 indicating our RNA-seq analysis was able to mimic theres quite well in terms of output. The discrepancy between them could be attributed to software drift between versions of Tophat (we utilised 2.1.0 as opposed to their 2.0.9 due to depreciation of the software previous models leading to its lack of availability) or perhaps differences in masking techniques in our methodology, due to insufficient documentation available to us.

### GO ENRICHMENT (OUR DATA)
To check that our pipeline reproduces the biologoical  reported in the paper, 
we perform **independent Gene Ontology (GO) enrichment analysis** on our 
significant genes using the clusterProfiler package. This tests whether the 
same biological processes are enriched in our data as the authors found in 
theirs.

The paper highlighted four key biological processes in outlined in Figure 5:

- Cell wall organization or biogenesis (GO:0071554)
- Cellular amino acid metabolic process (GO:0006520)
- Glycolysis (GO:0005975)
- Membrane lipid biosynthesis (GO:0006629)

We consequently ran GO enrichment separately for upregulated and downregulated genes in 
both Figure 5A (WT response to isobutanol) and Figure 5B (gln3Δ vs WT in 
isobutanol). We then extract genes belonging to these four key processes 
**from our own enrichment results** to color the volcano plots, allowing 
direct visual comparison with the paper's findings. This approach validates 
that our pipeline not only reproduces the statistical results but also 
independently confirms the significance of the same biological mechanisms.

```{r}
universe_list <- unique(our_data$gene_id[our_data$status == "OK"])

# Extract comparison
fig5a_data <- our_data %>%
  filter(
    status == "OK",
    sample_1 == "WT_NoIso",
    sample_2 == "WT_Iso"
  )

fig5a_up <- fig5a_data %>%
  filter(log2.fold_change. > 1, q_value < 0.05) %>%
  pull(gene_id)

fig5a_down <- fig5a_data %>%
  filter(log2.fold_change. < -1, q_value < 0.05) %>%
  pull(gene_id)

ego_5a_up <- enrichGO(
  gene          = fig5a_up,
  universe      = universe_list,
  OrgDb         = org.Sc.sgd.db,
  keyType       = "ORF",
  ont           = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.05
)

ego_5a_down <- enrichGO(
  gene          = fig5a_down,
  universe      = universe_list,
  OrgDb         = org.Sc.sgd.db,
  keyType       = "ORF",
  ont           = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.05
)

fig5b_data <- our_data %>%
  filter(
    status == "OK",
    sample_1 == "gln3_Iso",
    sample_2 == "WT_Iso"
  )
fig5b_up <- fig5b_data %>%
  filter(log2.fold_change. < -1, q_value < 0.05) %>%
  pull(gene_id)

fig5b_down <- fig5b_data %>%
  filter(log2.fold_change. > 1, q_value < 0.05) %>%
  pull(gene_id)

ego_5b_up <- enrichGO(
  gene          = fig5b_up,
  universe      = universe_list,
  OrgDb         = org.Sc.sgd.db,
  keyType       = "ORF",
  ont           = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.05
)

ego_5b_down <- enrichGO(
  gene          = fig5b_down,
  universe      = universe_list,
  OrgDb         = org.Sc.sgd.db,
  keyType       = "ORF",
  ont           = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.05
)

extract_gene_categories <- function(ego_result, category_name) {
  if (is.null(ego_result) || nrow(ego_result@result) == 0) {
    return(data.frame(gene_id = character(), category = character()))
  }

gene_list <- lapply(seq_len(nrow(ego_result@result)), function(i) {
    go_id <- ego_result@result$ID[i]
    go_desc <- ego_result@result$Description[i]
    genes <- unlist(strsplit(ego_result@result$geneID[i], "/"))
    
    data.frame(
      gene_id = genes,
      go_id = go_id,
      go_description = go_desc,
      stringsAsFactors = FALSE
    )
  })
  
  gene_df <- do.call(rbind, gene_list)
  return(gene_df)
}

key_go_terms <- c(
  "GO:0071554" = "Cell wall organization or biogenesis",
  "GO:0006520" = "Cellular amino acid metabolic process",
  "GO:0005975" = "Glycolysis",
  "GO:0006629" = "Membrane lipid biosynthesis"
)
map_to_key_categories <- function(ego_up, ego_down) {
  
  # Extract all genes from enrichment results
  genes_up <- extract_gene_categories(ego_up, "up")
  genes_down <- extract_gene_categories(ego_down, "down")
  
  # Combine
  all_genes <- rbind(genes_up, genes_down)
  
  # Filter to only the 4 key GO terms
  key_genes <- all_genes %>%
    filter(go_id %in% names(key_go_terms)) %>%
    mutate(category = key_go_terms[go_id]) %>%
    select(gene_id, category) %>%
    distinct()
  
  return(key_genes)
}

our_5a_categories <- map_to_key_categories(ego_5a_up, ego_5a_down)
our_5b_categories <- map_to_key_categories(ego_5b_up, ego_5b_down)

our_5a <- fig5a_data %>%
  transmute(
    gene_id,
    locus,
    log2FC = log2.fold_change.,
    pval = p_value,
    qval = q_value
  ) %>%
  left_join(our_5a_categories, by = "gene_id")

our_5a$category[is.na(our_5a$category)] <- "All other genes"

our_5b <- fig5b_data %>%
  transmute(
    gene_id,
    locus,
    log2FC = -log2.fold_change.,  # Flip sign
    pval = p_value,
    qval = q_value
  ) %>%
  left_join(our_5b_categories, by = "gene_id")

our_5b$category[is.na(our_5b$category)] <- "All other genes"

```
### Checking Results of Our GO Enrichment 
```{r}
key_terms <- data.frame(
  ID = c("GO:0071554", "GO:0006520", "GO:0005975", "GO:0006629"),
  Category = c(
    "Cell wall organization or biogenesis",
    "Cellular amino acid metabolic process",
    "Glycolysis",
    "Membrane lipid biosynthesis"
  ),
  stringsAsFactors = FALSE
)

#Helper function
get_term_data <- function(ego_object, condition_name) {
  if (is.null(ego_object) || nrow(ego_object@result) == 0) return(NULL)

  ego_object@result %>%
    filter(ID %in% key_terms$ID) %>%
    left_join(key_terms, by = "ID") %>%
    select(Category, p.adjust, Count, GeneRatio)
}
  
summary_table <- bind_rows(
  get_term_data(ego_5a_up,   "Fig 5A - Upregulated"),
  get_term_data(ego_5a_down, "Fig 5A - Downregulated"),
  get_term_data(ego_5b_up,   "Fig 5B - Upregulated"),
  get_term_data(ego_5b_down, "Fig 5B - Downregulated")
)
print(summary_table)
```
Our independent GO enrichment analysis successfully reproduces the core biological findings reported by Kuroda et al, finding cellular amino acid metabolism strongly upregulated in wild type cells under stress. Alongisde downregulation of glylcosis and cell wall organisation and validation of the GLN3 rescue by identifying significant differentrialexpressions of amino acid metabolism and glyolcsis between the gln3 mutant cells and the wild type. We were unable to find membrane lipid biosyntehsis enriched at a significant level, which could be attribute to the papers authors implementing a custom list of specific genes (noted in Figure S7), as opposed to using the GO database definition.
### Mapping Papers GO Enrichment Data 
By using the authors' published values (supplied in Supplementary materials, "Summary_of_RNA_seq_analysis_of_duplicates.txt), we were able to map their categories (Supplementary Table S6) to their data to allow for reproduction of their graphs, allowing us to visualize the exact gene sets they highlighted—such as those for glycolysis and amino acid biosynthesis—and establish a clear baseline for the expected transcriptomic shifts. This reconstruction serves as a reference point for validating our own workflow: by comparing the paper's volcano plots (colored using their Table S7 categories) against our own plots (colored using our independent GO enrichment results), we can visually assess whether our pipeline identifies the same biological processes.

```{r}
# Path to the supllementary materials, excel file containing data in Table 7 which contained their GO enrichment
path_s7 <- "../meta_data/1-s2.0-S2405471219303825-mmc4.xlsx"

# Table S7A-H
sheets_to_use <- paste0("Table S7", LETTERS[1:8])

# Read columns A and B from all sheets and stack them
go_list <- lapply(sheets_to_use, function(sh) {
  x <- read_excel(
    path_s7,
    sheet     = sh,
    skip      = 8,   # row 9 becomes header
    col_names = TRUE
  )
  x <- as.data.frame(x, stringsAsFactors = FALSE)
  x <- x[, 1:2, drop = FALSE]      # keep first two columns (GO term, genes)
  names(x) <- c("go_term", "genes")  # force consistent names
  x$sheet <- sh                      # remember which sheet it came from
  x
})

go_all <- do.call(rbind, go_list)

# Drop rows with NA terms/genes
keep <- !is.na(go_all$go_term) & !is.na(go_all$genes)
go_all <- go_all[keep, , drop = FALSE]

# Extract GO ID, e.g. "glycolysis (GO:0005975)" -> "GO:0005975"
go_all$go_id <- sub(".*(GO:[0-9]+).*", "\\1", go_all$go_term)

# Map GO IDs to the 4 categories for the volcano legend
go_id2cat <- c(
  "GO:0071554" = "Cell wall organization or biogenesis",
  "GO:0006520" = "Cellular amino acid metabolic process",
  "GO:0005975" = "Glycolysis",                   
  "GO:0006629" = "Membrane lipid biosynthesis"   
)

# Keep only rows whose GO ID is one of these 4 key categories
keep_go <- go_all$go_id %in% names(go_id2cat)
go_all  <- go_all[keep_go, , drop = FALSE]

# Expand comma-separated gene lists and assign categories
gene2cat_list <- lapply(seq_len(nrow(go_all)), function(i) {
  gid   <- go_all$go_id[i]
  genes <- go_all$genes[i]
  
  # Split comma-separated genes
  gvec <- unlist(strsplit(genes, ","))
  
  # Remove non-breaking spaces, then normal trim
  gvec <- gsub("\u00A0", "", gvec)  # strip NBSP
  gvec <- trimws(gvec)              # strip normal spaces
  gvec <- gvec[gvec != ""]          # drop any empty strings
  
  # Get category from GO ID
  cat <- if (!is.na(gid) && gid %in% names(go_id2cat)) {
    go_id2cat[[gid]]
  } else {
    "All other genes"
  }
  
  data.frame(
    gene     = gvec,
    category = rep(cat, length(gvec)),
    stringsAsFactors = FALSE
  )
})

gene2cat <- unique(do.call(rbind, gene2cat_list))

print(table(gene2cat$category))


# Paper Figure 5A: WT+Iso vs WT
paper_5a <- paper_dat %>%
  transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(WTIso_vs_WT0_log2FC),
    pval      = as.numeric(WTIso_vs_WT0_p),
    qval      = as.numeric(WTIso_vs_WT0_q)
  ) %>%
  left_join(gene2cat, by = c("gene_name" = "gene"))

paper_5a$category[is.na(paper_5a$category)] <- "All other genes"

# Paper Figure 5B: gln3Δ+Iso vs WT+Iso
paper_5b <- paper_dat %>%
  transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(Gln3Iso_vs_WTIso_log2FC),
    pval      = as.numeric(Gln3Iso_vs_WTIso_p),
    qval      = as.numeric(Gln3Iso_vs_WTIso_q)
  ) %>%
  left_join(gene2cat, by = c("gene_name" = "gene"))

paper_5b$category[is.na(paper_5b$category)] <- "All other genes"

```



### Volcano plot Function

To make the comparisons easier and ensure that both our results and the authors’ results are plotted in exactly the same way, we define a small helper function `volcano_plot_category()`, 
The features of the graph are as follow:
  - x-axis: log₂ fold change  
  - y-axis: –log₁₀(p-value)  
  - vertical dashed lines at |log₂FC| = 1  
  - a horizontal dashed line at p = 0.05  
Colored points are selected via category so that the four highlighted biological processes can be visually traced across the plot in the same manner as the original paper. 

```{r}
volcano_plot_category <- function(df,
                                  title      = "WT (1.3% Isobutanol) / WT (0% Isobutanol)",
                                  lfc_thresh = 1,
                                  p_thresh   = 0.05,
                                  point_size = 0.5) {

#unique column name constraint
  if (any(duplicated(names(df)))) {
    names(df) <- make.unique(names(df))
  }

#Filter and compute -log10(p)
  keep <- !is.na(df$log2FC) & !is.na(df$pval)
  df   <- df[keep, , drop = FALSE]

  df$neg_log10_p <- -log10(df$pval)


  cat_col <- NULL
  if ("category.1" %in% names(df)) {
    cat_col <- "category.1" 
  } else if ("category" %in% names(df)) {
    cat_col <- "category"
  }

  if (is.null(cat_col)) {
    cat_vec <- rep("All other genes", nrow(df))
  } else {
    cat_vec <- df[[cat_col]]
  }

# 3. Clean / normalise category labels and collapse to 5 labels according to papers graph
  cat_vec[is.na(cat_vec)] <- "All other genes"
  cat_vec <- trimws(cat_vec)
  low     <- tolower(cat_vec)

  cat_clean <- ifelse(low == "cell wall organization or biogenesis",
                      "Cell wall organization or biogenesis",
                ifelse(low == "cellular amino acid metabolic process",
                      "Cellular amino acid metabolic process",
                ifelse(low == "glycolysis",
                      "Glycolysis",
                ifelse(low == "membrane lipid biosynthesis",
                      "Membrane lipid biosynthesis",
                      "All other genes"))))

  df$category_plot <- factor(
    cat_clean,
    levels = c(
      "All other genes",
      "Cell wall organization or biogenesis",
      "Cellular amino acid metabolic process",
      "Glycolysis",
      "Membrane lipid biosynthesis"
    )
  )

  ## 4. Colour palette
  category_cols <- c(
    "All other genes"                        = "grey60",
    "Cell wall organization or biogenesis"   = "#1f77b4",
    "Cellular amino acid metabolic process"  = "#ff9ea6",
    "Glycolysis"                             = "#8fb5ff",
    "Membrane lipid biosynthesis"            = "#ffd66b"
  )

ggplot(df, aes(x = log2FC, y = neg_log10_p)) +
    geom_point(aes(colour = category_plot),
               size = point_size, alpha = 0.9) +
    
    
    geom_vline(xintercept = c(-lfc_thresh, lfc_thresh),
               linetype = "dashed", colour = "white", linewidth = 0.4) +
    geom_hline(yintercept = -log10(p_thresh),
               linetype = "dashed", colour = "white", linewidth = 0.4) +
    scale_x_continuous(limits = c(-10, 10)) +
    scale_y_continuous(limits = c(0, 5)) +
    
    scale_color_manual(
      values = category_cols,
      drop   = FALSE,
      name   = NULL
    ) +

    guides(colour = guide_legend(nrow = 3, byrow = TRUE)) +
    
    labs(
      title = title,
      x = expression(Log[2] ~ "fold change"),
      y = expression(-Log[10] ~ "p-value")
    ) +
    
    theme_minimal(base_size = 12) +
  theme(
    plot.background   = element_rect(fill = "white", colour = NA),
      panel.background  = element_rect(fill = "white", colour = NA),
      
      # Light grey grid lines (standard for publications)
      panel.grid.major  = element_line(colour = "grey92", linewidth = 0.3),
      panel.grid.minor  = element_line(colour = "grey96", linewidth = 0.2),
      
      # Black Text
      axis.text         = element_text(colour = "black"),
      axis.title        = element_text(colour = "black"),
      plot.title        = element_text(colour = "black", hjust = 0.5, margin = margin(b = 10)),
      
      # Legend Styling
      legend.background = element_rect(fill = "white", colour = NA),
      legend.key        = element_rect(fill = "white", colour = NA),
      legend.text       = element_text(colour = "black", size = 10),
      
      legend.position   = "bottom",
      legend.margin     = margin(t = 10),
      plot.margin       = margin(20, 20, 20, 20)
  )
}
```

## Plotting a volcano plot
We now generate volcano plots for each of the two contrasts using both
the published statistics and our own RNA-seq CuttDiff output. As all
plots are constructed with the same helper function, any differences
we see should primarily reflect differences in the underlying
statistics, not plotting discrepancies.

```{r}
#Our 5A: WT_NoIso / WT_Iso from gene_exp.diff 
fig5a_ours <- volcano_plot_category(
  our_5a,
  title = "WT (1.3% isobutanol) / WT (0% isobutanol) – our pipeline"
)
print(fig5a_ours)

# Our 5B: WT_Iso / gln3_Iso from gene_exp.diff
fig5b_ours <- volcano_plot_category(
  our_5b,
  title = "gln3Δ (1.3% isobutanol) / WT (1.3% isobutanol) – our pipeline"
)
print(fig5b_ours)
```

### Verification of of correlation between results
To be able to quantatively verify the accuracy of our reproduction of the paper, we performed a correlation analysis between our log2 fold changes reported by Kurdo et a. and those generated by our pipeline, We merged data sets via genes and visualized the relationship via scatter plot, the line of identity is represented by the red line, to see how far we deviate from the published data. We also computed the the correlation coefficnet (Pearsons R) at =0.852

```{r}
comparison <- merge( paper_5b %>% select(gene_id, paper_log2FC = log2FC, paper_pval = pval), our_5b %>% select(gene_id, our_log2FC = log2FC, our_pval = pval), by = "gene_id" )

correlation_plot <-ggplot(comparison, aes(x = paper_log2FC, y = our_log2FC)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Paper vs Our pipeline log2FC",
    x = "Paper log2FC",
    y = "Our pipeline log2FC"
  ) +
  theme_minimal()

#Computing Coefficent correlation
valid   <- is.finite(comparison$paper_log2FC) & is.finite(comparison$our_log2FC)
cor_lfc <- with(comparison[valid, ], cor(paper_log2FC, our_log2FC))
cat(sprintf("Log2FC correlation (finite only): %.3f\n", cor_lfc))
#Returns 0.852
```
#### Saving Plots
For Figure A: our replicated plot closely matches the authors original, in terms of shape. density of significant genes above thep-value threshold and the mapping of the categories, showing that we were able to successfully replicate their findings.

For Figure B: The consistency was also seen here between our group and their published data. The distribution of significant hits between categories is very similiar showing that our upstream mapping and more broadly our quantification and differential expression analysis faithfully reproduced the authors, allowing us to come to the same conclusion as their original paper.

```{r}
# Create output directory 
plots_dir <- "../plots"
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir, recursive = TRUE)
}

# Save papers Figure 5A
ggsave(
  filename = file.path(plots_dir, "Figure_5A_paper.png"),
  plot     = fig5a_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save papers Figure 5B
ggsave(
  filename = file.path(plots_dir, "Figure_5B_paper.png"),
  plot     = fig5b_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure 5A
ggsave(
  filename = file.path(plots_dir, "Figure_5A_replicate.png"),
  plot     = fig5a_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure 5B
ggsave(
  filename = file.path(plots_dir, "Figure_5B_replicate.png"),
  plot     = fig5b_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)
ggsave(
  filename = file.path(plots_dir, "Correlation_Analysis.png"),
  plot     = correlation_plot,
  width    = 6,
  height   = 6,
  dpi      = 300
)

write.csv(summary_table, file.path(plots_dir, "GO_ENRICHMENT_OF OUR_RESULTS.csv"),row.names=FALSE)
```


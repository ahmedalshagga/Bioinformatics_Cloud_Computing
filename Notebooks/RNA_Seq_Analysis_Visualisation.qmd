---
title: "Reproduction of Critical Roles of the Pentose Phosphate Pathway and GLN3 in Isobutanol-Specific Tolerance in Yeast RNA-Seq Analysis"
format: html
editor: visual
---n
---

## Introduction

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
install.packages("ggrepel")
install.packages("BiocManager")
BiocManager::install("EnhancedVolcano")
library(dplyr)
library(ggplot2)
library(readr)
library(ggrepel)
library(EnhancedVolcano)
library(readxl)
```

This notebook documents the analysis and visualization of RNA-seq data from the reproduction of Kuroda et al (2019). The pipeline consisted of alignment (TopHat), quantification (Cufflinks), and differentrial expression analysis (Cuffdiff) within the HPC cluster environment.

Here we load results, validate them against the published data supplied in Supplementary Info and visualize the key findings.

### Loading Data

```{r}
group_results_path <- "../processed_data/cuffdiff/gene_exp.diff"

# 1. Load results
our_data <- read.delim(group_results_path, header = TRUE, stringsAsFactors = FALSE)

group_results <- our_data %>%
  filter(sample_1 == "gln3_Iso", sample_2 == "WT_Iso") %>% 
  select(gene_id, locus, log2FC = log2.fold_change., pval = p_value, qval = q_value)

paper_results_path <- "../processed_data/Papers_Results"

# Read the paper table
paper_raw <- read.delim(
  paper_results_path,
  header = FALSE,
  stringsAsFactors = FALSE,
  check.names = FALSE
)

# Clean paper data
paper_dat <- paper_raw %>%
  dplyr::slice(4:n()) %>%
  dplyr::select(-c(17, 21, 25, 29, 33))

# Assign columns
colnames(paper_dat) <- c(
  "SystematicName", "GeneName", "NameDescription", "Locus",
  "WT0_Rep1", "WT0_Rep2", "WT0_mean",
  "WTIso_Rep1", "WTIso_Rep2", "WTIso_mean",
  "Gln30_Rep1", "Gln30_Rep2", "Gln30_mean",
  "Gln3Iso_Rep1", "Gln3Iso_Rep2", "Gln3Iso_mean",
  "Gln3Iso_vs_WTIso_log2FC", "Gln3Iso_vs_WTIso_p", "Gln3Iso_vs_WTIso_q",
  "Gln30_vs_WT0_log2FC",     "Gln30_vs_WT0_p",     "Gln30_vs_WT0_q",
  "Gln3Iso_vs_Gln30_log2FC", "Gln3Iso_vs_Gln30_p", "Gln3Iso_vs_Gln30_q",
  "WTIso_vs_WT0_log2FC",     "WTIso_vs_WT0_p",     "WTIso_vs_WT0_q",
  "Gln3Iso_vs_WT0_log2FC",   "Gln3Iso_vs_WT0_p",   "Gln3Iso_vs_WT0_q"
) #Inspected files for this

print(paste("Loaded", nrow(group_results), "genes from our analysis."))

print(paste("Loaded", nrow(paper_dat), "genes from papers analysis."))

```

We were able to load the same region of genes \~6,000 indicating our RNA-seq analysis was able to mimic theres quite well in terms of output. The discrepancy between them could be attributed to software drift between versions of Tophat (we utilised 2.1.0 as opposed to their 2.0.9 due to depreciation of the software previous models leading to its lack of availability) or perhaps differences in masking techniques in our methodology, due to insufficient documentation available to us.

### Data Validation

To validate the results from our pipeline, we will first compare our log2 fold change values against the authors published values (supplied in Supplementary materials, "Summary_of_RNA_seq_analysis_of_duplicates.txt), via volcano plot visualisation.

To check that our pipeline reproduces the biology reported in the paper, we next align our results with the authors’ Gene Ontology (GO) annotation and recreate their volcano plots.

The paper highlights four biological processes in Figure 5:

-   Cell wall organisation or biogenesis\

-   Cellular amino acid metabolic process\

-   Glycolysis\

-   Membrane lipid biosynthesis

The classification of each gene in these processes is was defined in Supplementary Table S7 (sheets S7A–S7H) of the paper. We read all eight sheets ( via readxl), keep the GO term and associated gene list columns, and stack them into a single table to allow for mapping of both our data and the papers published results to see if our "reproduction" was accurate.

```{r}
# Path to the Excel file
path_s7 <- "../meta_data/1-s2.0-S2405471219303825-mmc4.xlsx"

# Table 7A-H
sheets_to_use <- paste0("Table S7", LETTERS[1:8])

# Read columns A and B from all sheets and stack them
go_list <- lapply(sheets_to_use, function(sh) {
  x <- read_excel(
    path_s7,
    sheet     = sh,
    skip      = 8,   # row 9 becomes header
    col_names = TRUE
  )
  x <- as.data.frame(x, stringsAsFactors = FALSE)
  x <- x[, 1:2, drop = FALSE]      # keep first two columns (GO term, genes)
  names(x) <- c("go_term", "genes")  # force consistent names
  x$sheet <- sh                   # remember which sheet it came from
  x
})

go_all <- do.call(rbind, go_list)

# Drop rows with NA terms/genes
keep <- !is.na(go_all$go_term) & !is.na(go_all$genes)
go_all <- go_all[keep, , drop = FALSE]

# Extract GO ID, e.g. "glycolysis (GO:0005975)" -> "GO:0005975"
go_all$go_id <- sub(".*(GO:[0-9]+).*", "\\1", go_all$go_term)

# Map GO IDs to the 4 categories for the volcano legend
go_id2cat <- c(
  "GO:0071554" = "Cell wall organization or biogenesis",
  "GO:0006520" = "Cellular amino acid metabolic process",
  "GO:0005975" = "Glycolysis",                   
  "GO:0006629" = "Membrane lipid biosynthesis"   
)

# Keep only rows whose GO ID is one of these
keep_go <- go_all$go_id %in% names(go_id2cat)
go_all  <- go_all[keep_go, , drop = FALSE]

# Expand comma-separatedd gene lists and assign categories
gene2cat_list <- lapply(seq_len(nrow(go_all)), function(i) {
  gid   <- go_all$go_id[i]
  genes <- go_all$genes[i]

# split comma-separators
  gvec <- unlist(strsplit(genes, ","))

#remove non-breaking spaces, then normal trim
  gvec <- gsub("\u00A0", "", gvec)  # strip NBSP
  gvec <- trimws(gvec)              # strip normal spaces
  gvec <- gvec[gvec != ""]          # drop any empty strings

  # category from GO ID (fallback to "All other genes" just in case)
  cat <- if (!is.na(gid) && gid %in% names(go_id2cat)) {
    go_id2cat[[gid]]
  } else {
    "All other genes"
  }

  data.frame(
    gene     = gvec,
    category = rep(cat, length(gvec)),
    stringsAsFactors = FALSE
  )
})

gene2cat <- unique(do.call(rbind, gene2cat_list))

#Attach categories to paper_group (standard gene names)
# Build paper 5a (Gln3 Iso vs WT Iso)
paper_group <- paper_dat %>%
  dplyr::transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(WTIso_vs_WT0_log2FC),
    pval      = as.numeric(WTIso_vs_WT0_p),
    qval      = as.numeric(WTIso_vs_WT0_q)
  )
paper_group <- merge(
  paper_group,
  gene2cat,
  by.x = "gene_name",
  by.y = "gene",
  all.x = TRUE
)

paper_group$category[is.na(paper_group$category)] <- "All other genes"
print(table(paper_group$category))

# Build GeneName <-> SystematicName mapping from paper_dat 
id_map <- unique(paper_dat[, c("SystematicName", "GeneName")])

gene2cat_sys <- merge(
  id_map,
  gene2cat,
  by.x = "GeneName",  # from paper_dat (standard name)
  by.y = "gene",      # from gene2cat
  all.y = TRUE        # keep all genes in gene2cat
)

gene2cat_sys <- unique(gene2cat_sys[, c("SystematicName", "category")])
colnames(gene2cat_sys)[colnames(gene2cat_sys) == "SystematicName"] <- "gene_id"

our_5b <- our_data %>%
  dplyr::filter(status == "OK", sample_1 == "gln3_Iso", sample_2 == "WT_Iso") %>%
  dplyr::transmute(
    gene_id,
    locus,
    log2FC = -log2.fold_change., 
    pval   = p_value,
    qval   = q_value
  ) %>%
  merge(gene2cat_sys, by = "gene_id", all.x = TRUE)
our_5b$category[is.na(our_5b$category)] <- "All other genes"


# Build our 5A
our_5a <- our_data %>%
  dplyr::filter(
    status   == "OK",
    sample_1 == "WT_NoIso",
    sample_2 == "WT_Iso"
  ) %>%
  dplyr::transmute(
    gene_id,
    locus,
    log2FC = log2.fold_change., 
    pval   = p_value,
    qval   = q_value
  ) %>%
  merge(gene2cat_sys, by = "gene_id", all.x = TRUE)

our_5a$category[is.na(our_5a$category)] <- "All other genes"


#Build paper 5B

paper_5b <- paper_dat %>%
  dplyr::transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(Gln3Iso_vs_WTIso_log2FC),
    pval      = as.numeric(Gln3Iso_vs_WTIso_p),
    qval      = as.numeric(Gln3Iso_vs_WTIso_q)
  )

paper_5b <- merge(
  paper_5b,
  gene2cat,
  by.x = "gene_name",
  by.y = "gene",
  all.x = TRUE
)
paper_5b$category[is.na(paper_5b$category)] <- "All other genes"

```


###RNA-SEQ pipeline

This pipeline does a series of analyses, including quality control, index construction, read alignment, data processing, quantification, and RNA sequencing–related downstream analyses.

All of thesw scripts are called in a master script at the root project directory called RNA_Seq.Analysis.sh

Script 1 quality control:

```{bash}
#Preliminary Quality Check

#Initalising conda enviroment
eval "$(conda shell.bash hook)"
conda activate Quality_control_Env

#Defining Direc
raw_dir="raw_data"
FASTQC_OUT="processed_data/fastqc"
MULTIQC_OUT="processed_data/multiqc"


#Create Output Directories
echo "--> Creating output directories..."
mkdir -p "$FASTQC_OUT"
mkdir -p "$MULTIQC_OUT"

#Running the Quality Check
echo "Running FASTQC files in $raw_dir..."
fastqc "$raw_dir"/*.fastq.gz -o "$FASTQC_OUT"

echo "Running MultiQC aggregation..."
multiqc "$FASTQC_OUT" -o "$MULTIQC_OUT"

#  Cleanup of  fastqc folder since MultiQC has aggregated the data
echo "--> Deleting raw FastQC files to save disk space..."
rm -rf "$FASTQC_OUT"/*.zip

echo "Report available in $MULTIQC_OUT/multiqc_report.html"
```

This script was used to perform preliminary quality assessment of the raw sequencing reads. The workflow first initialized a dedicated Conda environment containing all required quality-control tools. The script defined the directories for the raw FASTQ files and the output folders used to store the FastQC and MultiQC results. FastQC was then executed on all .fastq.gz files in the raw-data directory to evaluate sequencing quality metrics, including per-base quality scores, GC content, duplication levels, and adapter contamination.

Following individual FastQC analyses, MultiQC was run to aggregate all FastQC outputs into a single comprehensive report, allowing efficient visualization and comparison of read-quality statistics across all samples. After aggregation, the temporary FastQC .zip files were removed to reduce disk usage. The final quality-control summary was saved as an HTML report generated by MultiQC.


```{bash}
#!/bin/bash
#SBATCH --partition=msc_appbio
#SBATCH --job-name=build_index
#SBATCH --output=logs/index_%j.output
#SBATCH --error=logs/index_%j.error
#SBATCH --nodes=1
#SBATCH --time=02:00:00
#SBATCH --mem=8G
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4

# Initialize Environment
eval "$(conda shell.bash hook)"
conda activate isobutanol_paper

#Set up Directories
REF_DIR="References"
ORIGINAL_FASTA="${REF_DIR}/S288C_reference_sequence_R64-1-1_20110203.fsa"
CLEAN_FASTA="${REF_DIR}/genome_clean.fa"
INDEX_DIR="${REF_DIR}/BowtieIndex"
INDEX_PREFIX="${INDEX_DIR}/genome"
ORIGINAL_GFF="${REF_DIR}/saccharomyces_cerevisiae_R64-1-1_20110208.gff"
NEW_GTF="${REF_DIR}/genes.gtf"

#Rename chromosomes in fasta
# This aligns the NCBI names (ref|NC_001133|) with SGD names (chrI)

echo "Renaming chromosomes in FASTA..."
if [ -f "$ORIGINAL_FASTA" ]; then
    sed 's/^>ref|NC_001133|.*/>chrI/' "$ORIGINAL_FASTA" | \
    sed 's/^>ref|NC_001134|.*/>chrII/' | \
    sed 's/^>ref|NC_001135|.*/>chrIII/' | \
    sed 's/^>ref|NC_001136|.*/>chrIV/' | \
    sed 's/^>ref|NC_001137|.*/>chrV/' | \
    sed 's/^>ref|NC_001138|.*/>chrVI/' | \
    sed 's/^>ref|NC_001139|.*/>chrVII/' | \
    sed 's/^>ref|NC_001140|.*/>chrVIII/' | \
    sed 's/^>ref|NC_001141|.*/>chrIX/' | \
    sed 's/^>ref|NC_001142|.*/>chrX/' | \
    sed 's/^>ref|NC_001143|.*/>chrXI/' | \
    sed 's/^>ref|NC_001144|.*/>chrXII/' | \
    sed 's/^>ref|NC_001145|.*/>chrXIII/' | \
    sed 's/^>ref|NC_001146|.*/>chrXIV/' | \
    sed 's/^>ref|NC_001147|.*/>chrXV/' | \
    sed 's/^>ref|NC_001148|.*/>chrXVI/' | \
    sed 's/^>ref|NC_001224|.*/>chrmt/' | \
    sed 's/^>ref|NC_001398|.*/>2-micron/' > "$CLEAN_FASTA"

    echo "Created clean FASTA at $CLEAN_FASTA"

#Build Index

echo "Building Bowtie2 index..."
mkdir -p "$INDEX_DIR"
bowtie2-build --threads 4 "$CLEAN_FASTA" "$INDEX_PREFIX"
echo "Index building complete."

#Conversion GFF to GTF
# Tophat requires GTF format. We use gffread to convert.
echo "Converting GFF to GTF..."

    gffread "$ORIGINAL_GFF" -T -o "$NEW_GTF"
    echo "Created GTF file at $NEW_GTF"

echo "All reference preparation tasks completed successfully."
```

The script initialized a dedicated Conda environment containing Bowtie2 and other required tools.

First, the script defined the directory structure and input files, including the original FASTA genome sequence and the corresponding GFF annotation file. Chromosome identifiers in the FASTA file were then standardized to match the Saccharomyces Genome Database (SGD) naming convention (e.g., chrI, chrII, …, chrXVI, and chrmt). This renaming step was performed using a series of sed commands and ensured consistent chromosome naming between the genome FASTA and gene-annotation files.

After generating the cleaned FASTA file, a Bowtie2 index was constructed using bowtie2-build with four CPU threads. The resulting index files were stored in a dedicated index directory for downstream alignment.

Finally, the script converted the original GFF annotation into GTF format using gffread, as some RNA-seq downstream tools require GTF rather than GFF. The resulting genes.gtf file and the Bowtie2 index together formed the complete reference package used for subsequent read alignment and quantification.

```{bash}
#!/bin/bash
#SBATCH --partition=msc_appbio
#SBATCH --job-name=yeast_alignment
#SBATCH --output=logs/align_%j.output
#SBATCH --error=logs/align_%j.error
#SBATCH --nodes=1
#SBATCH --time=8:00:00
#SBATCH --mem=8G
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4

#Mapping rna-seq reads to reference genome via Tophat
eval "$(conda shell.bash hook)"
conda activate isobutanol_paper

#Directory setup
RAW_DIR="raw_data"
REF_INDEX="References/BowtieIndex/genome"
OUT_DIR="processed_data/tophat"
GTF_FILE="References/genes.gtf"
BAM_DIR="processed_data/bams"

mkdir -p "$OUT_DIR"
mkdir -p "$BAM_DIR"
mkdir -p logs

#Code logic
for file in "$RAW_DIR"/*_1.fastq.gz; do
filename=$(basename "$file") #Extracting the sample name
sample_id="${filename%_1.fastq.gz}"
echo "Processing sample : $sample_id"

#Defining filename
r1="${RAW_DIR}/${sample_id}_1.fastq.gz"
r2="${RAW_DIR}/${sample_id}_2.fastq.gz"

#Specific output dir for this result
sample_out="${OUT_DIR}/${sample_id}"
mkdir -p "$sample_out"

#Running the Tophat programme
tophat -p 4 \
       -G "$GTF_FILE" \
       -o "$sample_out" \
      "$REF_INDEX" \
      "$r1" "$r2"
echo  "Finished mapping $sample_id"

if [ -f "$sample_out/accepted_hits.bam" ]; then
        cp "$sample_out/accepted_hits.bam" "$BAM_DIR/${sample_id}.bam"
        echo "--> Saved consolidated BAM to $BAM_DIR/${sample_id}.bam"
fi

done

echo "Mapping of all samples completed"
```
Also，The script initialized a dedicated Conda environment containing Tophat and its dependencies. And, defined the input directories for raw FASTQ files, the Bowtie2 reference index, the gene-annotation GTF file, and the output directories for Tophat results and final BAM files. It then iterated through all paired-end read files in the raw-data directory by detecting files ending in _1.fastq.gz. For each sample, the script extracted the sample ID, located the corresponding read 1 and read 2 files, and created a sample-specific output folder.

Tophat was executed for each sample using four CPU threads, with the GTF annotation file provided to guide spliced alignment. The cleaned reference genome index generated earlier was used as the alignment target. Upon completion, Tophat produced the standard alignment file accepted_hits.bam.

If the BAM file was successfully generated, it was copied into a centralized directory (processed_data/bams/) using the sample’s name, ensuring consistent file organization for downstream analyses. This loop continued until all samples were processed, after which the script reported the completion of the alignment step.

```{bash}
#!/bin/bash
#SBATCH --partition=msc_appbio
#SBATCH --job-name=bam_processing
#SBATCH --output=logs/processing_%j.output
#SBATCH --error=logs/processing_%j.error
#SBATCH --nodes=1
#SBATCH --time=08:00:00
#SBATCH --mem=16G
#SBATCH --ntasks=1

#Set up enviorment 
eval "$(conda shell.bash hook)"
conda activate isobutanol_paper

#Define Directories
INPUT_DIR="processed_data/bams"
OUTPUT_DIR="processed_data/processed_bams"

mkdir -p "$OUTPUT_DIR"
mkdir -p logs

#Code logic
for bam_file in "$INPUT_DIR"/*.bam; do
filename=$(basename "$bam_file")
sample_id="${filename%.bam}"

echo "Processing Sample : $sample_id"

#Intermediate files for program
sorted_bam="${OUTPUT_DIR}/${sample_id}_sorted.bam"
dedup_bam="${OUTPUT_DIR}/${sample_id}_deduplicated.bam" 
#shows the deduplicated version, ready for quantification
metrics_file="${OUTPUT_DIR}/${sample_id}_metrics.txt"
#allows for log of the data removed post-processing 


#Sorting bam files via picard
picard SortSam \
I="$bam_file" \
O="$sorted_bam" \
SORT_ORDER=coordinate \
VALIDATION_STRINGENCY=LENIENT

#Removing dupes
picard MarkDuplicates \
I="$sorted_bam" \
O="$dedup_bam" \
M="$metrics_file" \
REMOVE_DUPLICATES=true \
VALIDATION_STRINGENCY=LENIENT
rm "$sorted_bam" #removing intermediate files needed 

echo "Finished $sample_id processing"

done

echo "All samples processed, located in $OUTPUT_DIR"
```

This script was used to perform standardized post-alignment processing of RNA-seq BAM files prior to downstream quantification. Job parameters were defined through the scheduler, and a Conda environment containing Picard was activated at runtime.

The script specified directories for input BAM files (generated from Tophat) and output processed files. For each BAM file within the input directory, the script extracted the sample identifier and generated filenames for sorted BAMs, deduplicated BAMs, and Picard metrics logs.

Each BAM file first underwent coordinate sorting using Picard's SortSam tool, producing a sorted BAM file suitable for further processing. Following sorting, duplicate reads were identified and removed using MarkDuplicates with the REMOVE_DUPLICATES=true option. A metrics file was generated for each sample to document duplication rates and provide traceability for removed reads. After deduplication, the intermediate sorted BAM file was deleted to conserve storage space.

The final deduplicated BAM files, suitable for quantification or other downstream analyses, were saved in the designated output directory. The script iterated over all input samples and reported completion upon processing all available BAM files.

```{bash}
#!/bin/bash
#SBATCH --partition=msc_appbio
#SBATCH --job-name=cufflinks_quant
#SBATCH --output=logs/quantification_%j.output
#SBATCH --error=logs/quantification_%j.error
#SBATCH --nodes=1
#SBATCH --time=08:00:00
#SBATCH --mem=8G
#SBATCH --ntasks=4

#Initialise conda env
eval "$(conda shell.bash hook)"
conda activate isobutanol_paper

#Set up Directories
INPUT_DIR="processed_data/processed_bams"
OUTPUT_DIR="processed_data/cufflinks"
REF_ANNOTATION="References/genes.gtf"
MASK_FILE="References/rRNA_tRNA_mask.gtf"

mkdir -p "$OUTPUT_DIR"
mkdir -p logs

# Creating mask file (Extracting rRNA and tRNA lines from the annotation file)
echo "Creating rRNA/tRNA mask file..."
grep -E 'rRNA|tRNA' "$REF_ANNOTATION" > "$MASK_FILE"

#Code logic
for bam_file in "$INPUT_DIR"/*_deduplicated.bam
do
    filename=$(basename "$bam_file") #Decouple bam suffix
    sample_id="${filename%_deduplicated.bam}"
    echo "Quantifying sample: $sample_id"

    sample_out="${OUTPUT_DIR}/${sample_id}"
    mkdir -p "$sample_out"

    #Cufflinks programme
    # Note: Using -g/-G with GFF files works in newer Cufflinks, 
    # but strictly GTF is preferred. If this fails, the GFF may need conversion.
    cufflinks -p 4 \
    -G "$REF_ANNOTATION" \
    -M "$MASK_FILE" \
    -o "$sample_out" \
    "$bam_file"

    echo "Finished $sample_id"
done

echo "Quantification step complete"
```


The script was used to generate transcript abundance estimates from the processed RNA-seq BAM files.  The Cufflinks suite was activated prior to quantification.

The script began by defining directory paths for the input BAM files, the output quantification directory, the reference GTF annotation file, and a mask file used to exclude non-coding RNA features. A mask file containing rRNA and tRNA annotations was created by extracting all corresponding entries from the reference GTF using a regular-expression search. This mask file prevents highly abundant rRNA/tRNA reads from inflating transcript-expression estimates.

For each deduplicated BAM file, the script extracted the sample identifier and created a dedicated output directory. Cufflinks was then executed with four threads, using the reference GTF file to guide transcript assembly and quantification. The -G option constrained the analysis to known gene models, and the -M option applied the rRNA/tRNA mask to exclude unwanted alignments. The resulting transcript FPKM estimates, along with associated tracking and model files, were written to the sample-specific output directory.

```{bash}
#!/bin/bash
#SBATCH --partition=msc_appbio
#SBATCH --job-name=cuffdiff_de
#SBATCH --output=logs/DE_analysis_%j.output
#SBATCH --error=logs/DE_analysis_%j.error
#SBATCH --nodes=1
#SBATCH --time=12:00:00
#SBATCH --mem=16G
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4

# Initialize Environment
eval "$(conda shell.bash hook)"
conda activate isobutanol_paper

# Set up Directories
BAM_DIR="processed_data/processed_bams"
OUTPUT_DIR="processed_data/cuffdiff"
REF_GTF="References/genes.gtf"
MASK_FILE="References/rRNA_tRNA_mask.gtf"

mkdir -p "$OUTPUT_DIR"
mkdir -p logs

# Creating mask file (with non-coding RNA added for robustness)
grep -iE 'rRNA|tRNA|snoRNA|snRNA|ncRNA' "$REF_GTF" > "$MASK_FILE"

# Files 94-97 had 0 expression of GLN3
GLN3_NO_ISO="${BAM_DIR}/ERR3450094_deduplicated.bam,${BAM_DIR}/ERR3450095_deduplicated.bam"
GLN3_ISO="${BAM_DIR}/ERR3450096_deduplicated.bam,${BAM_DIR}/ERR3450097_deduplicated.bam"

# WILD TYPE (WT)
# Files 98-101 had expression of GLN3
WT_NO_ISO="${BAM_DIR}/ERR3450098_deduplicated.bam,${BAM_DIR}/ERR3450099_deduplicated.bam"
WT_ISO="${BAM_DIR}/ERR3450100_deduplicated.bam,${BAM_DIR}/ERR3450101_deduplicated.bam"

echo "Starting differential expression analysis with cuffdiff"

# Run Cuffdiff
cuffdiff \
    -p 4 \
    -o "$OUTPUT_DIR" \
    -L gln3_NoIso,gln3_Iso,WT_NoIso,WT_Iso \
    -M "$MASK_FILE" \
    --library-type fr-unstranded \
    --no-update-check \
    "$REF_GTF" \
    "$GLN3_NO_ISO" "$GLN3_ISO" "$WT_NO_ISO" "$WT_ISO"

echo "Differential Expression Complete, results in $OUTPUT_DIR/gene_exp.diff"
```

Differential expression analysis was conducted using Cuffdiff. Aligned, deduplicated BAM files were organized into four biological conditions (GLN3_NoIso, GLN3_Iso, WT_NoIso, WT_Iso), each containing replicates. To prevent inflated expression estimates from highly abundant non-coding RNAs, a mask file containing rRNA, tRNA, snoRNA, snRNA, and ncRNA annotations was generated and applied during analysis. Cuffdiff was run in reference-guided mode using the curated GTF annotation and an fr-unstranded library setting. The resulting differential expression statistics were reported in the default output files, including gene_exp.diff.




### Volcano plot Function

To make the comparisons easier and ensure that both our results and the authors’ results are plotted in exactly the same way, we define a small helper function `volcano_plot_category()`, 
The features of the graph are as follow:
  - x-axis: log₂ fold change  
  - y-axis: –log₁₀(p-value)  
  - vertical dashed lines at |log₂FC| = 1  
  - a horizontal dashed line at p = 0.05  
Colored points are selected via category so that the four highlighted biological processes can be visually traced across the plot in the same manner as the original paper. 

```{r}
volcano_plot_category <- function(df,
                                  title      = "WT (1.3% Isobutanol) / WT (0% Isobutanol)",
                                  lfc_thresh = 1,
                                  p_thresh   = 0.05,
                                  point_size = 0.5) {

#unique column name constraint
  if (any(duplicated(names(df)))) {
    names(df) <- make.unique(names(df))
  }

#Filter and compute -log10(p)
  keep <- !is.na(df$log2FC) & !is.na(df$pval)
  df   <- df[keep, , drop = FALSE]

  df$neg_log10_p <- -log10(df$pval)


  cat_col <- NULL
  if ("category.1" %in% names(df)) {
    cat_col <- "category.1" 
  } else if ("category" %in% names(df)) {
    cat_col <- "category"
  }

  if (is.null(cat_col)) {
    cat_vec <- rep("All other genes", nrow(df))
  } else {
    cat_vec <- df[[cat_col]]
  }

# 3. Clean / normalise category labels and collapse to 5 labels according to papers graph
  cat_vec[is.na(cat_vec)] <- "All other genes"
  cat_vec <- trimws(cat_vec)
  low     <- tolower(cat_vec)

  cat_clean <- ifelse(low == "cell wall organization or biogenesis",
                      "Cell wall organization or biogenesis",
                ifelse(low == "cellular amino acid metabolic process",
                      "Cellular amino acid metabolic process",
                ifelse(low == "glycolysis",
                      "Glycolysis",
                ifelse(low == "membrane lipid biosynthesis",
                      "Membrane lipid biosynthesis",
                      "All other genes"))))

  df$category_plot <- factor(
    cat_clean,
    levels = c(
      "All other genes",
      "Cell wall organization or biogenesis",
      "Cellular amino acid metabolic process",
      "Glycolysis",
      "Membrane lipid biosynthesis"
    )
  )

  ## 4. Colour palette
  category_cols <- c(
    "All other genes"                        = "grey60",
    "Cell wall organization or biogenesis"   = "#1f77b4",
    "Cellular amino acid metabolic process"  = "#ff9ea6",
    "Glycolysis"                             = "#8fb5ff",
    "Membrane lipid biosynthesis"            = "#ffd66b"
  )

ggplot(df, aes(x = log2FC, y = neg_log10_p)) +
    geom_point(aes(colour = category_plot),
               size = point_size, alpha = 0.9) +
    
    
    geom_vline(xintercept = c(-lfc_thresh, lfc_thresh),
               linetype = "dashed", colour = "white", linewidth = 0.4) +
    geom_hline(yintercept = -log10(p_thresh),
               linetype = "dashed", colour = "white", linewidth = 0.4) +
    scale_x_continuous(limits = c(-10, 10)) +
    scale_y_continuous(limits = c(0, 5)) +
    
    scale_color_manual(
      values = category_cols,
      drop   = FALSE,
      name   = NULL
    ) +

    guides(colour = guide_legend(nrow = 3, byrow = TRUE)) +
    
    labs(
      title = title,
      x = expression(Log[2] ~ "fold change"),
      y = expression(-Log[10] ~ "p-value")
    ) +
    
    theme_minimal(base_size = 12) +
    theme(
      plot.background   = element_rect(fill = "black", colour = NA),
      panel.background  = element_rect(fill = "black", colour = NA),
      panel.grid.major  = element_line(colour = "#444444", linewidth = 0.3),
      panel.grid.minor  = element_line(colour = "#333333", linewidth = 0.2),
      
      axis.text         = element_text(colour = "white"),
      axis.title        = element_text(colour = "white"),
      

      plot.title        = element_text(colour = "white", hjust = 0.5, margin = margin(b = 10)),
      
      legend.background = element_rect(fill = "black", colour = NA),
      legend.key        = element_rect(fill = "black", colour = NA),
      

      legend.text       = element_text(colour = "white", size = 10), 
      legend.position   = "bottom",
      legend.margin     = margin(t = 10), 
      plot.margin       = margin(20, 20, 20, 20) 
    )
}
```

## Plotting a volcano plot
We now generate volcano plots for each of the two contrasts using both
the published statistics and our own RNA-seq CuttDiff output. As all
plots are constructed with the same helper function, any differences
we see should primarily reflect differences in the underlying
statistics, not plotting discrepancies.

```{r}
fig5a_paper <- volcano_plot_category(
  paper_group,
  title = "WT (1.3% isobutanol) / WT (0% isobutanol) – paper data"
)
print(fig5a_paper)

# Paper 5B: gln3Δ(1.3) / WT(1.3) from paper_dat
fig5b_paper <- volcano_plot_category(
  paper_5b,
  title = "gln3Δ (1.3% isobutanol) / WT (1.3% isobutanol) – paper data"
)
print(fig5b_paper)

#Our 5A: WT_NoIso / WT_Iso from gene_exp.diff 
fig5a_ours <- volcano_plot_category(
  our_5a,
  title = "WT (1.3% isobutanol) / WT (0% isobutanol) – our pipeline"
)
print(fig5a_ours)

# Our 5B: WT_Iso / gln3_Iso from gene_exp.diff
fig5b_ours <- volcano_plot_category(
  our_5b,
  title = "gln3Δ (1.3% isobutanol) / WT (1.3% isobutanol) – our pipeline"
)
print(fig5b_ours)
```

<<<<<<< HEAD
### Verification of of correlation between results
To be able to quantatively verify the accuracy of our reproduction of the paper, we performed a correlation analysis between our log2 fold changes reported by Kurdo et a. and those generated by our pipeline, We merged data sets via genes and visualized the relationship via scatter plot, the line of identity is represented by the red line, to see how far we deviate from the published data. We also computed the the correlation coefficnet (Pearsons R) at =0.852

```{r}
comparison <- merge( paper_5b %>% select(gene_id, paper_log2FC = log2FC, paper_pval = pval), our_5b %>% select(gene_id, our_log2FC = log2FC, our_pval = pval), by = "gene_id" )

correlation_plot <-ggplot(comparison, aes(x = paper_log2FC, y = our_log2FC)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Paper vs Our pipeline log2FC",
    x = "Paper log2FC",
    y = "Our pipeline log2FC"
  ) +
  theme_minimal()

#Computing Coefficent correlation
valid   <- is.finite(comparison$paper_log2FC) & is.finite(comparison$our_log2FC)
cor_lfc <- with(comparison[valid, ], cor(paper_log2FC, our_log2FC))
cat(sprintf("Log2FC correlation (finite only): %.3f\n", cor_lfc))
#Returns 0.852
```

### Figure S7 (Located in Supplementary)
Figure S7A and S7B showed differential expression by comparing transcriptomic profiles of different yeast strains under different conditions. Supplementary Figure 7A showed the differences in gene expression in Gln3 strains in the presence and absence of isobutanol. Supplementary Figure 7B showed the differences in gene expression in Gln3 and WT strains in the absence of isobutanol. A workflow similar to Figure 5A and 5B visualisations were used. Following GO enrichment mapping of categories, Paper Figure S7A (paper_group) and B data was defined as seen below. 
```{r}
#paper figure S7A data defined
#first a new dataframe derived from the paper_dat dataframe containing selected columns
#log2FC, pval and qval values used to define transcriptomic profile comparisons to be visualised in the volcano plot
paper_group <- paper_dat %>%
  dplyr::transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(Gln3Iso_vs_Gln30_log2FC),
    pval      = as.numeric(Gln3Iso_vs_Gln30_p),
    qval      = as.numeric(Gln3Iso_vs_Gln30_q)
  )
#merge gene2cat dataframe and paper_group dataframe using gene_name=gene
paper_group <- merge(
  paper_group,
  gene2cat,
  by.x = "gene_name",
  by.y = "gene",
  all.x = TRUE
)
#any categories not predefined (during GO enrichment category mapping) classified as "All other genes"
paper_group$category[is.na(paper_group$category)] <- "All other genes"
print(table(paper_group$category))

#Figure S7B paper data defined
paper_7b <- paper_dat %>%
  dplyr::transmute(
    gene_id   = SystematicName,
    gene_name = GeneName,
    locus     = Locus,
    log2FC    = as.numeric(Gln30_vs_WT0_log2FC),
    pval      = as.numeric(Gln30_vs_WT0_p),
    qval      = as.numeric(Gln30_vs_WT0_q)
  )

paper_7b <- merge(
  paper_7b,
  gene2cat,
  by.x = "gene_name",
  by.y = "gene",
  all.x = TRUE
)
paper_7b$category[is.na(paper_7b$category)] <- "All other genes"
```
This workflow was also applied to our own data. 
```{r}
#Supplementary Figure S7 defined under our own data.
# relevant transcriptomic profiles to compare are filtered
#from the filtered data, columns are selected.
#our_7a data frame merged with gene2cat_sys dataframe
our_7a <- our_data %>%
  dplyr::filter(
    status   == "OK",
    sample_1 == "gln3_NoIso",
    sample_2 == "gln3_Iso"
  ) %>%
  dplyr::transmute(
    gene_id,
    locus,
    log2FC = log2.fold_change., 
    pval   = p_value,
    qval   = q_value
  ) %>%
  merge(gene2cat_sys, by = "gene_id", all.x = TRUE)
#undefined categories are termed as "All other genes"
our_7a$category[is.na(our_7a$category)] <- "All other genes"
```
After the data has been defined, they can be applied to the volcano_plot_category function. The titles of each plot reflected the source of the data and the transcriptomic profiles being compared.
```{r}

fig7a_paper <- volcano_plot_category(
  paper_group,
  title = "Gln3 (1.3% isobutanol) / Gln3 (0% isobutanol) – paper data"
)
print(fig7a_paper)

# Paper 7B: gln3Δ(1.3) / WT(1.3) from paper_dat
fig7b_paper <- volcano_plot_category(
  paper_7b,
  title = "gln3Δ (0% isobutanol) / WT (0% isobutanol) – paper data"
)
print(fig7b_paper)

#Our 7A: Gln3_Iso / Gln3_NoIso from gene_exp.diff 
fig7a_ours <- volcano_plot_category(
  our_7a,
  title = "Gln3 (1.3% isobutanol) / Gln3 (0% isobutanol) – our pipeline"
)
print(fig7a_ours)

# Our 7B: Gln3_Iso / WT_Iso from gene_exp.diff
fig7b_ours <- volcano_plot_category(
  our_7b,
  title = "gln3Δ (1.3% isobutanol) / WT (1.3% isobutanol) – our pipeline"
)
print(fig7b_ours)
```
After plots for Figure S7A and B had been created, a correlation analysis was conducted to determine whether our results were similar. Firstly, the results from our data and from the study data was merged by gene_id. A correlation plot to show differences between datasets were plotted. An ideal linear relationship between our data and their data would be y=x (shown in red on the correlation plot). The correlation coefficient was calculated to be 0.844. Therefore, there was a strong correlation between our data and the study data. This suggests that our findings were similar to study findings. 
```{r}
#correlation analysis
#merge study dataset and our dataset
comparison_S7 <- merge( paper_7b %>% select(gene_id, paper_log2FC_S7 = log2FC, paper_pval_S7 = pval), our_7b %>% select(gene_id, our_log2FC_S7 = log2FC, our_pval_S7 = pval), by = "gene_id" )

#create a correlation plot to show the differences
correlation_plot <-ggplot(comparison_S7, aes(x = paper_log2FC_S7, y = our_log2FC_S7)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Paper vs Our pipeline log2FC",
    x = "Paper log2FC",
    y = "Our pipeline log2FC"
  ) +
  theme_minimal()

#Computing correlation
valid   <- is.finite(comparison_S7$paper_log2FC_S7) & is.finite(comparison_S7$our_log2FC_S7)
cor_lfc <- with(comparison_S7[valid, ], cor(paper_log2FC_S7, our_log2FC_S7))
cat(sprintf("Log2FC correlation (finite only): %.3f\n", cor_lfc))
#returned value = 0.844 (3s.f.)
```


#### Saving Plots
For Figure 5A: our replicated plot closely matches the authors original, in terms of shape. density of significant genes above thep-value threshold and the mapping of the categories, showing that we were able to successfully replicate their findings.
=======
For Figure A: our replicated plot closely matches the authors original, in terms of shape. density of significant genes above thep-value threshold and the mapping of the categories, showing that we were able to successfully replicate their findings.
>>>>>>> 61dce5eab364aa952dc3a553a9d100c2381171b2

For Figure 5B: The consistency was also seen here between our group and their published data. The distribution of significant hits between categories is very similiar showing that our upstream mapping and more broadly our quantification and differential expression analysis faithfully reproduced the authors, allowing us to come to the same conclusion as their original paper.

For Supplementary Figure S7A: our plot is similar to the study plot as there are many conserved trends (shape, values over the p-value threshold, datapoint distribution). Therefore, based on our findings, results of this study were reproducible. However, as seen with the correlation analysis, there were slight differences.

For Supplementary Figure S7B: Similar to observations for Figure S7A, our plot was similar to the study plot on the basis of conserved trends. Therefore, study findings were reproducible. However, there were slight differences as a perfect correlation (coefficient =1) was not seen in the correlation analysis. 

```{r}
# Create output directory 
plots_dir <- "../plots"
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir, recursive = TRUE)
}

# Save papers Figure 5A
ggsave(
  filename = file.path(plots_dir, "Figure_5A_paper.png"),
  plot     = fig5a_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save papers Figure 5B
ggsave(
  filename = file.path(plots_dir, "Figure_5B_paper.png"),
  plot     = fig5b_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure 5A
ggsave(
  filename = file.path(plots_dir, "Figure_5A_replicate.png"),
  plot     = fig5a_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure 5B
ggsave(
  filename = file.path(plots_dir, "Figure_5B_replicate.png"),
  plot     = fig5b_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)
<<<<<<< HEAD
#save correlation plot for Figure 5
ggsave(
  filename = file.path(plots_dir, "Correlation_Analysis.png"),
  plot     = correlation_plot,
  width    = 6,
  height   = 6,
  dpi      = 300
)
# Save papers Figure S7A
ggsave(
  filename = file.path(plots_dir, "Figure_7A_paper.png"),
  plot     = fig7a_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save papers Figure S7B
ggsave(
  filename = file.path(plots_dir, "Figure_7B_paper.png"),
  plot     = fig7b_paper,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure S7A
ggsave(
  filename = file.path(plots_dir, "Figure_7A_replicate.png"),
  plot     = fig7a_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)

# Save our Figure S7B
ggsave(
  filename = file.path(plots_dir, "Figure_7B_replicate.png"),
  plot     = fig7b_ours,
  width    = 6,
  height   = 6,
  dpi      = 300
)
#saving correlation analysis for Figure S7 data
ggsave(
  filename = file.path(plots_dir, "Correlation_Analysis_for_S7.png"),
  plot = correlation_plot_s7,
  width = 6,
  height = 6,
  dpi = 300
)
=======
>>>>>>> 61dce5eab364aa952dc3a553a9d100c2381171b2

```
